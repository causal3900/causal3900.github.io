---
title: "Discussion. Parametric g-formula: Outcome modeling"
author: Cornell STSCI / INFO / ILRST 3900 \break Fall 2025 \break \href{https://causal3900.github.io/}{\textcolor{blue}{causal3900.github.io}}
date: 08 Oct 2025
format: beamer
date-format: DD MMM YYYY
header-includes:
  \usecolortheme{dove}
  \setbeamertemplate{footline}[page number]
editor_options: 
  chunk_output_type: console
---

```{r, include = F}
knitr::opts_chunk$set(echo = T)
```



```{r, include = F, eval = T}
library(tidyverse)
d <- readRDS("d.RDS")
```

## Statistical modeling

Under exchangeability, $$E\left(Y^a\mid\vec{L} = \vec\ell\right) = E\left(Y^a\mid A = a, \vec{L} = \vec\ell\right)$$
Under consistency, $$E\left(Y^a\mid A = a,\vec{L} = \vec\ell\right) = E\left(Y\mid A = a, \vec{L} = \vec\ell\right)$$

To estimate, we have been taking the subgroup mean $$\hat{E}(Y\mid A = a, \vec{L} = \vec\ell) = \frac{1}{n_{a,\vec\ell}}\sum_{i:A_i=a,\vec{L}_i=\vec\ell} Y_i$$ When subgroups are empty, we need a model. Example:

$$\hat{E}\left(Y\mid A = a, \vec{L} = \vec\ell\right) = \hat\alpha + A\hat\beta + \vec{L}'\hat{\vec\gamma} + A\vec{L}'\hat{\vec\eta}$$

## Parametric g-formula: Outcome modeling

1.  Learn a model to predict $Y$ given $\{A,\vec{L}\}$
2.  For each $i$, predict
    -   $\{A = 1,\vec{L} = \vec\ell_i\}$, the conditional average outcome under treatment
    -   $\{A = 0, \vec{L} = \vec\ell_i\}$, the conditional average outcome under control
3.  Take the difference for each unit
4.  Average over the units

## G-formula: Data example

Estimate a model based on the true data

```{r, echo=FALSE}
d |>
  select(a:race) |>
  head(10) |>
  arrange(a)
```

## Predict values - control

Predict the counterfactuals when everybody is in the control group
```{r, echo=FALSE}
d |>
  select(a:race, -y) |>
  head(10) |>
  arrange(a) |>
  mutate(a = "no_college")
```

## Predict values - treatment

Predict the counterfactuals when everybody is in the treatment group
```{r, echo=FALSE}
d |>
  select(a:race, -y) |>
  head(10) |>
  arrange(a) |>
  mutate(a = "college")
```

## 1. Learn a model to predict $Y$ given $\{A,\vec{L}\}$

```{r}
fit <- lm(y ~ a + sex + race + mom_educ + dad_educ + 
                   log_parent_income + 
                   log_parent_wealth + 
                   test_percentile,
          data = d)
```

## 2. Predict conditional average potential outcomes for every unit

```{r}
conditional_average_outcomes <- d %>%
  mutate(yhat1 = predict(fit, 
                         newdata = d %>% 
                           mutate(a = "college")),
         yhat0 = predict(fit, 
                         newdata = d %>% 
                           mutate(a = "no_college")))
```

## 3. Difference to estimate conditional average effects

```{r}
conditional_average_effects <- 
  conditional_average_outcomes %>%
  mutate(effect = yhat1 - yhat0)
```

## 4. Average over units

```{r}
conditional_average_effects %>%
  select(yhat1, yhat0, effect) %>%
  summarize_all(.funs = mean)
```

## Recap. Parametric g-formula: Outcome modeling

1.  Learn a model to predict $Y$ given $\{A,\vec{L}\}$
2.  For each $i$, predict
    -   $\{A = 1,\vec{L} = \vec\ell_i\}$, the conditional average outcome under treatment
    -   $\{A = 0, \vec{L} = \vec\ell_i\}$, the conditional average outcome under control
3.  Take the difference for each unit
4.  Average over the units

## Extension 1: IPW Estimator
We can also estimate the causal effect using an IPW estimator
$$ \pi_i = P(A_i = 1 \mid L = \ell_i) $$

-   read about using `glm()` to estimate logistic regression

-   when using `predict()`, search to find out how to predict probabilities

```{r}
# turn outcome into 0/1
d <- d %>% 
  mutate(a_binary = a == "college")

# Estimate propensity score using logistic regression
propensity_model <- glm(a_binary ~ sex + race +
                          mom_educ + dad_educ +
                          log_parent_income +
                          log_parent_wealth +
                          test_percentile,
                        family = binomial, data = d)
```

## IPW: Estimate the causal effect
Use the estimated propensty scores to calculate the ACE

$$\hat E(Y^1) = \frac{1}{n} \sum_i \frac{A_i Y_i}{\hat \pi_i} $$
$$\hat E(Y^0) = \frac{1}{n} \sum_i \frac{(1-A_i) Y_i}{1-\hat \pi_i} $$

```{r}
# Add propensity score
d <- d %>% 
  mutate(ps = predict(propensity_model,
                      newdata = d, type = "response"))

## 
d <- d %>% 
  mutate(weightedMean = a_binary*y / ps -
           (1-a_binary)*y /(1- ps))


```

## IPW: Estimate the causal effect
```{r}
  d %>% select(weightedMean) %>%
  summarize_all(.funs = mean)
```


## Extension 2: Conditional average effects

Modify the procedure above to estimate the average effect in subgroups defined by mom's education:

1.  those with `sex == Male`
2.  those with `sex == Female`


. . .

One way to code it:

```{r}
conditional_average_effects %>%
  group_by(sex) %>%
  select(sex, yhat0,yhat1,effect) %>%
  summarize_all(.funs = mean)
```

## Extension 2: Logistic regression

Since out outcome is binary, it's more appropriate to use logistic regression.
Repeat the steps above with logistic regression

$$\text{log}\left(\frac{\hat{P}\left(Y\mid A = a, \vec{L} = \vec\ell\right)}{1 - \hat{P}\left(Y\mid A = a, \vec{L} = \vec\ell\right)}\right) = \hat\alpha + A\hat\beta + \vec{L}'\hat{\vec\gamma} + A\vec{L}'\hat{\vec\eta}$$ Helpful hints:



## Extension: Logistic regression

Fit a model

```{r}
fit <- glm(y ~ a*(sex + race + mom_educ + dad_educ + 
                    log_parent_income + 
                    log_parent_wealth + 
                    test_percentile),
           data = d,
           family = binomial)
```

## Extension: Logistic regression

Predict and summarize to estimate the average effect

\footnotesize
```{r}
d %>%
  mutate(yhat1 = predict(fit, 
                         newdata = d %>% 
                           mutate(a = "college"), 
                         type = "response"),
         yhat0 = predict(fit, 
                         newdata = d %>% 
                           mutate(a = "no_college"), 
                         type = "response"),
         effect = yhat1 - yhat0) %>%
  select(yhat1,yhat0,effect) %>%
  summarize_all(.funs = mean)
```

## Recap. Parametric g-formula: Outcome modeling

1.  Learn a model to predict $Y$ given $\{A,\vec{L}\}$
2.  For each $i$, predict
    -   $\{A = 1,\vec{L} = \vec\ell_i\}$, the conditional average outcome under treatment
    -   $\{A = 0, \vec{L} = \vec\ell_i\}$, the conditional average outcome under control
3.  Take the difference for each unit
4.  Average over the units
