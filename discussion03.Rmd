---
output: html_document
---
<style>li {line-height: 1.8;}</style>

# Discussion 3. Treatment effect heterogneity in an Experiment {-}
## STSCI/INFO/ILRST 3900: Causal Inference {-}
#### September 10, 2025 {-}


You can download the [**slides.**](assets/discussions/discussion3-addHealth.pdf) for this week's discussion.

## Get out and Vote Experiment {-}

Last week, we explored an experiment that digs into the mechanisms
underlying __why people vote__. This exercise is based on: 

Gerber, Alan S., Donald P. Green, and Christopher W. Larimer. ["Social Pressure and Voter Turnout: Evidence from a Large-scale Field Experiment."](https://www.cambridge.org/core/journals/american-political-science-review/article/social-pressure-and-voter-turnout-evidence-from-a-largescale-field-experiment/11E84AF4C0B7FBD1D20C855972C2C3EB#) American Political Science Review 102.1 (2008): 33-48.

A long-standing theory as to why many people
vote is that it is driven by social norms (e.g. the understanding that voting
is their civic duty). This theory, while being a dominant theoretical 
explanation, had very little empirical backing for a long time. This experiment
examines this very theory by asking the question:
__to what extent do social norms cause voter turnout__?

### Experimental Design {-}

In order to answer this question, approximately 80,000 Michigan households
were randomly assigned to treatment and control groups, where the treatment
group was randomly assigned to one of four possible treatment arms. These
treatment arms varied in the intensity of social pressure that they conveyed,
and were defined as follows:

1. The first treatment arm was mailed a letter that simply reminded them that
voting is a civic duty.
2. The second treatment arm was mailed a letter telling them that researchers
would be studying their voting turnout based on public records.
3. The third treatment arm was mailed a letter stating that their voting turnout 
would be revealed to all other members of their household.
4. The fourth treatment arm was mailed a letter stating that their voting turnout
would be revealed to their household *and* to their neighbors.

## Analyze Experiment {-}

### Necessary packages {-}

```{r message=FALSE}
library(dplyr)
library(haven)
library(kableExtra)
```

### Import data {-}
```{r}
gotv <- read_dta("https://causal3900.github.io/assets/data/social_pressure.dta")
```

### Clean data {-}

First, we construct an age variable describing how old (in number of years) each person was in the year 2006. The `yob` variable says which year each person was born in. \> For this, we use the `mutate` function. 
Then, we convert the `treatment` variable from it's numeric representation to the corresponding labels which are

-   0: "Control"
-   1: "Hawthorne" (this is the 'researchers viewing records via public data' treatment arm)
-   2: "Civic Duty" (this is the 'voting is your civic duty' treatment arm)
-   3: "Neighbors" (this is the 'voting turnout revealed to neighbors' treatment arm)
-   4: "Self" (this is the 'voting turnout revealed to household' treatment arm)

For this, we use the `case_when` function. 

```{r}

gotv <- gotv |>
  mutate(treatment = case_when(
    treatment == 0 ~ "Control",
    treatment == 1 ~ "Hawthorne",
    treatment == 2 ~ "Civic Duty",
    treatment == 3 ~ "Neighbors",
    treatment == 4 ~ "Self")) 


gotv <- gotv |>
  mutate(age = 2006 - yob)
```


### Average Causal Effect {-}

Finally, for each treatment group, we calculate the percentage of individuals who got out and voted, as well as the total number of individuals in that group! The solutions below use the function [`n`](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8/topics/n) which counts the number of observations in the current group for you.

```{r}         
gotv_results <- gotv |>
  group_by(treatment) |>
  summarise(Per_Voting = mean(voted), num_of_individuals = n())

print(gotv_results)
```


### Conditional Average Causal Effect {-}

Now, we look into the treatment effect across sub-population, so we can determine if there is treatment effect heterogeneity

First, we assign into age groups and household size groups
```{r}
gotv <- gotv |>
  mutate(ageGroup = cut(age, breaks = c(18, 30, 45, 60, 120))) |>
  mutate(hhGroup = cut(hh_size, breaks = c(0,1, 2, 10)))

```

#### Examine voting by age group {-}
```{r}
gotv_results_age <- gotv |>
  group_by(ageGroup, treatment) |>
  summarise(
    Per_Voting = mean(voted),
    Count = n(),
    .groups = "drop"
  ) |>
  group_by(treatment) |>
  mutate( Per_in_AgeGroup = Count / sum(Count))

print(gotv_results_age, n = Inf)
```


#### Examine voting by hh size group {-}

```{r}
gotv_results_hh <- gotv |>
  group_by(hhGroup, treatment) |>
  summarise(
    Per_Voting = mean(voted),
    Count = n(),
    .groups = "drop"
  ) |>
  group_by(treatment) |>
  mutate( Per_in_hhGroup = Count / sum(Count) ) 

print(gotv_results_hh, n = Inf)
```


### Questions: {-}
- Does there seem to be heterogeneity in treatment effects across age and/or house hold size?
- Could you improve voting rates by assigning different treatments to different individuals?
- What would you expect the treatment effect for civic duty if we considered a population that was evenly split across the 4 age groups?

To answer these questions it might be useful to slightly rearrange table:
```{r}
gotv_results_age <- gotv |>
  group_by(ageGroup, treatment) |>
  summarise(
    Per_Voting = mean(voted),
    Count = n(),
    .groups = "drop"
  ) |>
  group_by(treatment) |>
  mutate(
    Per_in_AgeGroup = Count / sum(Count)
  ) |>
  group_by(ageGroup) |>
  mutate(
    Control_Voting = Per_Voting[treatment == "Control"],
    Difference_from_Control = Per_Voting - Control_Voting
  ) |>
  ungroup()


gotv_results_age |>
  arrange(treatment,ageGroup) |>
  kbl() |>
  kable_styling(font_size = 12, full_width = FALSE) |>
  scroll_box(width = "100%", height = "500px")
```



### Answers: {-}
- Does there seem to be heterogeneity in treatment effects across age and/or house hold size?

> We say there is treatment effect heterogeneity if the treatment effect varies across sub-population. To check if there's treatment effect heterogeneity across age groups, we look at $E[Y^{a=j}|L=l]-E[Y^{a=0}|L=l]$ for each age group $l$, and treatment $j$.
> For example, the "Civic Duty" treatment effect for individuals ages 18-30 is
\begin{align*}
E\big[Y^{a="Civic Duty"}|L=(18-30]\big]-&E\big[Y^{a="Control"}|L=(18-30]\big]]\\ &= 0.166-0.156\\&=0.001
\end{align*}

> These values can be found in the following table, `gotv_results_ageGroup`
```{r message=FALSE}
gotv_results_ageGroup <- gotv |>
  group_by(ageGroup, treatment) |>
  summarise(
    Per_Voting = mean(voted),
    Count = n())
```

> A nice way to present this table would be using the variable `Difference_from_Control`, created above. This table makes it easier to look at the causal effect across age groups and examining whether the effect is fixed or not
```{r echo=FALSE}
Difference_from_Control <- 
   gotv_results_age |>
   as.data.frame() |>
   select(treatment,ageGroup,Difference_from_Control) |>
   reshape(direction = "wide",idvar = "ageGroup",timevar = "treatment")
names(Difference_from_Control) <-
  sub("Difference_from_Control\\.", "",names(Difference_from_Control))
Difference_from_Control |>
  kbl()
```


- What would you expect the treatment effect for civic duty if we considered a population that was evenly split across the 4 age groups?

> First, let's consider the average treatment effect for Civic Duty, which is given by:
$$E[Y|a=\text{Civic Duty}]-E[Y|a=\text{Control}]$$
> Standardization allows us to estimate the ACE by combining
estimates from each sub-population
$$\sum_l P(L=l)E[Y|a=\text{Civic Duty},L=l]-\sum_l P(L=l)E[Y|a=\text{Control},L=l]$$
$$\sum_l P(L=l) \Big(E[Y|a=\text{Civic Duty},L=l]-E[Y|a=\text{Control},L=l]\Big)$$
For the age group the ACE looks like:
\begin{align*} ACE =& 0.111 \times (0.166-0.156)  \\  &+0.260 \times (0.293-0.268)\\&+0.421\times (0.320-0.310)\\&+ 0.208\times (0.410-0.378)
\end{align*}

> ```{r}
gotv_results_age |>
   filter(treatment=="Civic Duty") |>
   summarise(sum(Per_in_AgeGroup*Difference_from_Control))
> ```
To estimate the treatment effect for civic duty if the population was evenly split across the 4 age group, we replace the share of each age group with $0.25$.
> ```{r}
gotv_results_age |>
   filter(treatment=="Civic Duty") |>
   summarise(sum(.25*Difference_from_Control))
> ```

